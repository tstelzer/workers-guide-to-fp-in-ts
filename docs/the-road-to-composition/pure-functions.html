<html lang="en"><head><base href="/workers-guide-to-fp-in-ts/"/><meta charSet="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta http-equiv="X-UA-Compatible" content="ie=edge"/><title>A Workers Guide To Typed Functional Programming</title><link rel="stylesheet" href="styles.css"/></head><body><h1 class="page-title">A Workers Guide To Typed Functional Programming</h1><div class="layout"><nav class="nav"><h3 class="nav-title">Jump To Chapter</h3><ol><li><a href="index.html">Introduction</a><ol></ol></li><li><a href="the-road-to-composition.html">The road to composition</a><ol><li><a href="the-road-to-composition/pure-functions.html">Pure Functions</a></li><li><a href="the-road-to-composition/functions-as-values.html">Functions as values</a></li></ol></li></ol></nav><main class="main"><h2 class="chapter-title">Pure Functions</h2><div><h3 id="capitalism-ho">Capitalism, ho!</h3>
<p>As you step onto the creaking floor boards of the old shop, you breathe in a
whiff of mouldy air. You firmly grip the key in your hand, melancholy washing
over you, as you recall the many times you spent helping your granny running the shop
in your childhood. Brushing off a layer of thick dust on the counter, you begin
to inspect the inventory.</p>
<p><a href="./inventory-01.json">inventory.json</a></p>
<p>Grandmother supplied ingredients to adventurous alchemists, and you are picking
up the trade. She used to do her accounting with pen and paper, but you will
bring the shop into the 21th century, modeling the shop in a TypeScript
program. So far, the list of ingredients look simple enough, let&#x27;s describe it
in a <code>type</code>. Ingredients have a unique <code>name</code>, a <code>cost</code>, which denotes how much
we payed for them, and a <code>rarity</code>, which describes a range of how likely it is
to find, from <code>0</code> to <code>1</code>, with <code>1</code> being abundant.</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token comment">// file: Ingredient.ts</span>
<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token maybe-class-name">Ingredient</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    cost<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
    rarity<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>This <code>type</code> describes the shape, or structure of the data in our program (think
<code>struct</code>, if you&#x27;re familiar with that term). We can then define functions that
take data of this type and transform it. For example, we could define a
constructor function that creates data that fits the <code>Ingredient</code> type:</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token comment">// file: Ingredient.ts</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token keyword">from</span> <span class="token operator">=</span> <span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> cost<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> rarity<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token parameter"><span class="token maybe-class-name">Ingredient</span></span> <span class="token arrow operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token punctuation">,</span>
    cost<span class="token punctuation">,</span>
    rarity<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Note that, unlike in object-oriented programming, our data is not an instance
of a class. It is just that, data. Simple, serializable, context-free data.
Our <code>Ingredient</code> does not have any behaviour (methods) attached to it. Any
transformations we need, we will define as functions that take data of the type
<code>Ingredient</code> as input. Note that our constructor function is just a helper,
we don&#x27;t actually need it to create an <code>Ingredient</code>:</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token comment">// file: Ingredient.test.ts</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> <span class="token constant">I</span> <span class="token keyword">from</span> <span class="token string">&#x27;./Ingredient&#x27;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> flower <span class="token operator">=</span> <span class="token constant">I</span><span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span><span class="token string">&#x27;Flower&#x27;</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.95</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&#x27;Ingredient::from&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&#x27;creates a single ingredient&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">expect</span><span class="token punctuation">(</span>flower<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toStrictEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">&#x27;Flower&#x27;</span><span class="token punctuation">,</span> cost<span class="token punctuation">:</span> <span class="token number">0.1</span><span class="token punctuation">,</span> rarity<span class="token punctuation">:</span> <span class="token number">0.95</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Both pieces of data can be considered an <code>Ingredient</code>. In fact, any data that
shares properties with our type can be, for all intents and purposes,
considered an <code>Ingredient</code>. Here is a function <code>name</code>, that takes an
<code>Ingredient</code> and returns its <code>name</code>:</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token comment">// file: Ingredient.ts</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">name</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">ingredient<span class="token punctuation">:</span> <span class="token maybe-class-name">Ingredient</span></span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> ingredient<span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">;</span>
</code></pre>
<p>We can use it on both pieces of data, the one we created manually and the
one by using <code>from</code>:</p>
<pre class="language-git"><code class="language-git">// file: Ingredient.test.ts
@@ -7,3 +7,9 @@ describe(<span class="token string">&#x27;Ingredient::from&#x27;</span>, () =&gt; {
         expect(flower).toStrictEqual({name: <span class="token string">&#x27;Flower&#x27;</span>, cost: 0.1, rarity: 0.95});
     });
 });
<span class="token inserted">+</span>
<span class="token inserted">+describe(&#x27;Ingredient::name&#x27;, () =&gt; {</span>
<span class="token inserted">+    it(&#x27;returns the name of an ingredient&#x27;, () =&gt; {</span>
<span class="token inserted">+        expect(I.name(flower)).toStrictEqual(&#x27;Flower&#x27;);</span>
<span class="token inserted">+    });</span>
<span class="token inserted">+});</span>
</code></pre>
<p>TypeScript requires us to be exact about the properties when passing in an
object literal into <code>name</code>, the following will not compile, warning us that
<code>color</code> does not exist on our <code>Ingredient</code> type:</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token constant">I</span><span class="token punctuation">.</span><span class="token method function property-access">name</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token string">&#x27;Tyme&#x27;</span><span class="token punctuation">,</span>
    cost<span class="token punctuation">:</span> <span class="token number">0.2</span><span class="token punctuation">,</span>
    rarity<span class="token punctuation">:</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
    <span class="token comment">// Does not compile.</span>
    color<span class="token punctuation">:</span> <span class="token string">&#x27;green&#x27;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>TypeScript will also complain when we explicitly hint the type and we
define our data ad-hoc:</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> tyme<span class="token punctuation">:</span> <span class="token constant">I</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Ingredient</span></span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token string">&#x27;Tyme&#x27;</span><span class="token punctuation">,</span>
    cost<span class="token punctuation">:</span> <span class="token number">0.2</span><span class="token punctuation">,</span>
    rarity<span class="token punctuation">:</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
    <span class="token comment">// Does not compile.</span>
    color<span class="token punctuation">:</span> <span class="token string">&#x27;green&#x27;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>Interestingly, when we drop the type hint, we can define the data prior and
pass it into <code>name</code> without TypeScript complaining:</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> tyme <span class="token operator">=</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token string">&#x27;Tyme&#x27;</span><span class="token punctuation">,</span>
    cost<span class="token punctuation">:</span> <span class="token number">0.2</span><span class="token punctuation">,</span>
    rarity<span class="token punctuation">:</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
    color<span class="token punctuation">:</span> <span class="token string">&#x27;green&#x27;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token constant">I</span><span class="token punctuation">.</span><span class="token method function property-access">name</span><span class="token punctuation">(</span>tyme<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>This is expected behaviour, as TypeScript is using <a href="https://www.typescriptlang.org/docs/handbook/type-compatibility.html">structural sub typing</a>,
meaning that a piece of data is considered of type some <code>A</code>, when its
properties match those of <code>A</code>. Excess properties are ignored. Only when we
<em>explicitly</em> use a type hint, or constructor function, will TypeScript complain
about excess properties. One interesting property that follows from this is
that one piece of data can match many types:</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">type</span> <span class="token constant">A</span> <span class="token operator">=</span> <span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">type</span> <span class="token constant">B</span> <span class="token operator">=</span> <span class="token punctuation">{</span> bar<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">f</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">:</span> <span class="token constant">A</span></span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> a<span class="token punctuation">.</span><span class="token property-access">foo</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">g</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">b<span class="token punctuation">:</span> <span class="token constant">B</span></span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> b<span class="token punctuation">.</span><span class="token property-access">bar</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>foo<span class="token punctuation">:</span> <span class="token string">&#x27;Jeff&#x27;</span><span class="token punctuation">,</span> bar<span class="token punctuation">:</span> <span class="token number">24</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &#x27;Jeff&#x27;</span>
<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token function">g</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 24</span>
</code></pre>
<p>In our case, when a JavaScript object has the properties <code>name</code>, <code>cost</code>, and <code>rarity</code> that
are of the primitive types <code>string</code>, <code>number</code> and <code>number</code> respectively, we can
use it in any function that requires an <code>Ingredient</code>, even when we didn&#x27;t explicitly
define it as such.</p>
<h3 id="a-store-from-boards-and-nails">A store from boards and nails</h3>
<p>Alright, now that we&#x27;ve defined our data type, let&#x27;s think about what else we need
for our little item store to work. Rummaging around in grannies cupboards, you can&#x27;t
find the program she was using to buy and sell ingredients, so we have to write our
own. To make it easier for ourselfes, and as is the premise of this tutorial, we will
write the store using stateless, pure functions. Immutable transformations or
&quot;pure functions&quot;, by definition, produce the same output for the same input.
Every time. Not only does this have benefits for the reasonability of our
program, it is essentially the prerequisite for writing it in a composable,
functional style. In later chapters, we can explore deeper the reasons,
benefits and problems for that, for now, let&#x27;s just start writing.</p>
<p>For now, our <code>Store</code> will simply hold the inventory, a list of all
<code>Ingredient</code>s we have available. This is somewhat of a naíve way to represent
the inventory, but we will have plenty of opportunity to change and refactor
this code.</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token comment">// file: Store.ts</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> <span class="token constant">I</span> <span class="token keyword">from</span> <span class="token string">&#x27;./Ingredient&#x27;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token maybe-class-name">Store</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    inventory<span class="token punctuation">:</span> <span class="token constant">I</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Ingredient</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> create <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token parameter"><span class="token maybe-class-name">Store</span></span> <span class="token arrow operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    inventory<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Here, <code>create</code> acts as a constructor function for our <code>Store</code>, which is a plain
object. Unlike in classical object-oriented programming, we&#x27;re not
instantiating an object, we&#x27;re simply creating plain data. It does not have any
behaviour (&quot;methods&quot;) attached, and thus is stateless. If we want to change
it, we have to define pure functions that transform it, creating new data,
without changing the original. Though we&#x27;re co-locating them, we&#x27;re clearly separating
between the data type (<code>Store</code>) and our transformations (so far only <code>create</code>).</p>
<p>Note that we can still combine object-oriented programming and functional
programming in an elegant way, by using type classes, if we want to. Defining
that is beyond this chapter though.</p>
<p>A pure function has a couple of properties:</p>
<ol>
<li>Following the principle of least astonishment, for any function input <code>a</code>, it always returns the output <code>b</code>, regardless of how often we call it, or in which context. For example, the function<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> <span class="token function-variable function">add</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
</code></pre>always returns <code>4</code> for the inputs <code>1</code> and <code>3</code>. A formal way of describing this property saying that the function is &quot;referentially transparent&quot;, that is, you could replace the function invocation with its result, without breaking the program.</li>
<li>It does not depend on its context or scope, otherwise it would break (1).</li>
<li>It does not mutate its inputs, otherwise calling it multiple times with the same inputs would result in different outputs, and thus break (1).</li>
<li>It does not cause any side effects in your program, it simply returns values. This is more of a theoretical problem, some side effects are harmless, others change the environment in a way where calling the function multiple times would result in different results, which would, again, break (1). Examples include making api calls, updating a database, interacting with the file system.</li>
</ol>
<p>Callign <code>create</code>, unremarkably, creates a plain object that fits the <code>Store</code> type:</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token comment">// file: run.ts</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> <span class="token constant">S</span> <span class="token keyword">from</span> <span class="token string">&#x27;./Store.ts&#x27;</span>

<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token constant">S</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Granny left us a little bit of cash, <code>$95.4</code>, not enough to live decadently. Let&#x27;s
extend the <code>Store</code>, so that it holds a balance, and an alternative constructor that
allows us to define an initial stock and balance.</p>
<pre class="language-git"><code class="language-git">// file: Store.ts
@@ -2,8 +2,21 @@ import * as I from <span class="token string">&#x27;./Ingredient&#x27;</span>;
 
 export type Store = {
     inventory: I.Ingredient[];
<span class="token inserted">+    balance: number;</span>
 };
 
 export const create = (): Store =&gt; ({
     inventory: [],
<span class="token inserted">+    balance: 0,</span>
<span class="token inserted">+});</span>
<span class="token inserted">+</span>
<span class="token inserted">+export const from = ({</span>
<span class="token inserted">+    inventory,</span>
<span class="token inserted">+    balance,</span>
<span class="token inserted">+}: {</span>
<span class="token inserted">+    inventory: I.Ingredient[];</span>
<span class="token inserted">+    balance: number;</span>
<span class="token inserted">+}): Store =&gt; ({</span>
<span class="token inserted">+    inventory,</span>
<span class="token inserted">+    balance,</span>
 });
</code></pre>
<p>Now we use <code>from</code> to generate a store with our humble balance and inventory.</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token comment">// file: run.ts</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> <span class="token constant">S</span> <span class="token keyword">from</span> <span class="token string">&#x27;./Store&#x27;</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> inventory <span class="token keyword">from</span> <span class="token string">&#x27;./inventory.json&#x27;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token constant">S</span><span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span><span class="token punctuation">{</span>inventory<span class="token punctuation">,</span> balance<span class="token punctuation">:</span> <span class="token number">95.4</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>And we can see that our store is still a plain object:</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><a href="./02-store-output.json&#x27;">store-output.json</a></p>
<p>But we still can&#x27;t do anything with our store. Let&#x27;s change that by extending it
with a function to stock up on ingredients:</p>
<pre class="language-typescript"><code class="language-typescript">@@ <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span> <span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">12</span> @@
 <span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> <span class="token constant">I</span> <span class="token keyword">from</span> <span class="token string">&#x27;./Ingredient&#x27;</span><span class="token punctuation">;</span>
 
<span class="token operator">+</span><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">BalanceExhausted</span> <span class="token keyword">extends</span> <span class="token class-name">Error</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token string">&quot;The balance can&#x27;t go below 0.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">name</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">constructor</span><span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token punctuation">}</span>
<span class="token operator">+</span><span class="token punctuation">}</span>
<span class="token operator">+</span>
 <span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token maybe-class-name">Store</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
     inventory<span class="token punctuation">:</span> <span class="token constant">I</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Ingredient</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
     balance<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
@@ <span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">3</span> <span class="token operator">+</span><span class="token number">27</span><span class="token punctuation">,</span><span class="token number">21</span> @@ <span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token keyword">from</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
     inventory<span class="token punctuation">,</span>
     balance<span class="token punctuation">,</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>
<span class="token doc-comment comment">+/**
+ * Adds `ingredient` to the `store`, given that the balance can
+ * cover the cost.
+ *
+ * @throws BalanceExhausted
+ */</span>
<span class="token operator">+</span><span class="token keyword">export</span> <span class="token keyword">const</span> stockOne <span class="token operator">=</span> <span class="token punctuation">(</span>store<span class="token punctuation">:</span> <span class="token maybe-class-name">Store</span><span class="token punctuation">,</span> ingredient<span class="token punctuation">:</span> <span class="token constant">I</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Ingredient</span></span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token parameter"><span class="token maybe-class-name">Store</span></span> <span class="token arrow operator">=&gt;</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>    <span class="token keyword">const</span> balance <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token property-access">balance</span> <span class="token operator">-</span> ingredient<span class="token punctuation">.</span><span class="token property-access">cost</span><span class="token punctuation">;</span>
<span class="token operator">+</span>
<span class="token operator">+</span>    <span class="token comment">// There are no money lenders around in this back-water town. We can only</span>
<span class="token operator">+</span>    <span class="token comment">// work with the money we&#x27;ve got in the balance.</span>
<span class="token operator">+</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>balance <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BalanceExhausted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token punctuation">}</span>
<span class="token operator">+</span>
<span class="token operator">+</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span>inventory<span class="token punctuation">:</span> store<span class="token punctuation">.</span><span class="token property-access">inventory</span><span class="token punctuation">.</span><span class="token method function property-access">concat</span><span class="token punctuation">(</span>ingredient<span class="token punctuation">)</span><span class="token punctuation">,</span> balance<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>Note that <code>stockOne</code> does not mutate the passed in <code>store</code>, but instead creates
a new object. We&#x27;re being naive here in forcing immutability by aggressively
copying data. While individually, the cost is small, in a large application the
memory overhead <em>will</em> add up. We <em>can</em> alleviate some of the cost by using
libraries that provide data structures made specifically for enabling
immutability (such as <a href="https://www.npmjs.com/package/immer">immer.js</a>). Other
languages, such as Haskell, Rust or Clojure afford us immutable data by design,
and offer built-in efficient, immutable data structures. For the purposes of
this tutorial though, the memory overhead is a trade-off we are willing to
make.</p>
<p>Our function is not quite pure, though, as we don&#x27;t have an elegant way yet to
handle failure cases in our program (later we will use the <code>Either</code> type to do
that), so we we will resort to the crude way of throwing exceptions.</p>
<p>For now that is good enough, we&#x27;ll refactor it later. Let&#x27;s verify our new
functionality:</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token comment">// file: Store.test.ts</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> <span class="token constant">I</span> <span class="token keyword">from</span> <span class="token string">&#x27;./Ingredient&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> <span class="token constant">S</span> <span class="token keyword">from</span> <span class="token string">&#x27;./Store&#x27;</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&#x27;Store::stockOne&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token function-variable function">createInitialStore</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token constant">S</span><span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span><span class="token punctuation">{</span>inventory<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> balance<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> initialStore <span class="token operator">=</span> <span class="token function">createInitialStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&#x27;stocks a single ingredient&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> flower <span class="token operator">=</span> <span class="token constant">I</span><span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span><span class="token string">&#x27;Flower&#x27;</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.95</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">expect</span><span class="token punctuation">(</span><span class="token constant">S</span><span class="token punctuation">.</span><span class="token method function property-access">stockOne</span><span class="token punctuation">(</span>initialStore<span class="token punctuation">,</span> flower<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toStrictEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            balance<span class="token punctuation">:</span> <span class="token number">9.9</span><span class="token punctuation">,</span>
            inventory<span class="token punctuation">:</span> <span class="token punctuation">[</span>flower<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&#x27;throws when cost exceeds the balance&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> gold <span class="token operator">=</span> <span class="token constant">I</span><span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span><span class="token string">&#x27;Gold&#x27;</span><span class="token punctuation">,</span> <span class="token number">900</span><span class="token punctuation">,</span> <span class="token number">0.01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">expect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token constant">S</span><span class="token punctuation">.</span><span class="token method function property-access">stockOne</span><span class="token punctuation">(</span>initialStore<span class="token punctuation">,</span> gold<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toThrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&#x27;does not mutate the store&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">expect</span><span class="token punctuation">(</span>initialStore<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toStrictEqual</span><span class="token punctuation">(</span><span class="token function">createInitialStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="next-up">Next up</h3>
<p>Wonderful, but before we can attract any customers, we need a function
to sell ingredients. And that&#x27;s where you come in. As an exercise,
implement the function <code>sellOne</code> in the <code>Store</code> namespace.</p>
<ul>
<li><code>sellOne</code> takes a <code>Store</code> and a string <code>name</code>, and removes an ingredient with
that name from the inventory, increasing the <code>balance</code> by its cost.</li>
<li>Because we want to turn a profit, we need to sell at some <code>profitMargin</code>.
Extend the <code>Store</code> and its functions with a <code>profitMargin</code>, and use that in
<code>sellOne</code> to turn a profit.</li>
</ul>
<p>To test your skills ...</p>
<ol>
<li>Clone, and prepare this repository:<pre class="language-bash"><code class="language-bash"><span class="token function">git</span> clone https://github.com/tstelzer/workers-guide-to-fp-in-ts
<span class="token builtin class-name">cd</span> workers-guide-to-fp-in-ts
<span class="token function">npm</span> ci
</code></pre></li>
<li>Run the test suite:<pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> run <span class="token builtin class-name">test</span> -- exercises/01 --watch
</code></pre></li>
<li>Extend the code in <code>exercises/01</code> until the tests pass.</li>
</ol>
<p>Good luck, and see you in the next chapter.</p></div></main></div></body></html>